<?php
$user = SAE_MYSQL_USER;
$psd = SAE_MYSQL_PASS;
$host = SAE_MYSQL_HOST_M.':'.SAE_MYSQL_PORT;

define("INDEX_PATIENT_GENDER", 4);
define("INDEX_PATIENT_AGE", 5);
define("INDEX_DIAGNOSIS", 10);
define("INDEX_RECEPTION", 11);
define("INDEX_REGISTRATION", 12);
define("INDEX_WAIT", 13);
define("INDEX_DOCTOR", 14);
define("INDEX_CONSULTATION", 17);


function get_total_count(){
	$mysql = new SaeMysql();
	$sql = "select count(*) from outpatient_log";
	$data = $mysql->getLine($sql);
	echo $data["count(*)"];
	$mysql->closeDb();
	return $data["count(*)"];
}

function get_first_date(){
	$mysql = new SaeMysql();
	$sql = "select min(registration_time) from outpatient_log";
	$data = $mysql->getLine($sql);
	echo $data["min(registration_time)"];
	$mysql->closeDb();
}

function get_last_date(){
	$mysql = new SaeMysql();
	$sql = "select max(registration_time) from outpatient_log";
	$data = $mysql->getLine($sql);
	echo $data["max(registration_time)"];
	$mysql->closeDb();
}

function get_attribute_description($index){

	$t_count = get_total_count();

	$mysql = new SaeMysql();
	$sql = "";
	$data = NULL;

	switch($index){
		#get count for genders
		case INDEX_PATIENT_GENDER:
			$gender = array("male"=>0,"female"=>0);
			$sql = "select count(*) from outpatient_log where patient_gender = '男'";
			$data = $mysql->getLine($sql);
			$gender['male'] = $data["count(*)"];
			$sql = "select count(*) from outpatient_log where patient_gender = '女'";
			$data = $mysql->getLine($sql);
			$gender['female'] = $data["count(*)"];
			$mysql->closeDb();
			return $gender;
		#get count for different age ranges
		case INDEX_PATIENT_AGE:
			$age = array("10s"=>0,"20s"=>0,"30s"=>0,"40s"=>0,"50s"=>0,"60s"=>0,"70s"=>0,"else"=>0);
			for($i = 0 ; $i < 7 ; $i ++){
				$sql = "select count(*) from outpatient_log where patient_age > "
						.($i * 10).
						" and patient_age < "
						.(($i + 1) * 10);
				$data = $mysql->getLine($sql);
				$age["".(($i + 1) * 10)."s"] = $data["count(*)"];
			}
			$sql = "select count(*) from outpatient_log where patient_age > 70";
			$data = $mysql->getLine($sql);
			$age["else"] = $data["count(*)"];
			$mysql->closeDb();
			return $age;
		#generate diagnosis with count
		case INDEX_DIAGNOSIS:
			$diagnosis = array();
			$diagnosis["total"] = $t_count;
			#obtain 10000 data at a time
			// for($i = 0 ; $i < $t_count ; $i += 10000){
			// 	$sql = "select (index, diagnosis) from outpatient_log where index > "
			// 			.($i * 10000)." and index < ".(($i + 1) * 10000);
			// 	$data = $mysql->getData($sql);
			// 	#for each data generate its diagnosis and their count
			// 	foreach ($data as $element) {
			// 		$key = $element["diagnosis"];
			// 		#get all diagnosis of a transaction
			// 		$newKeyList = keyGeneralization($key);
			// 		#for each diagnosis add its count
			// 		foreach ($newKeyList as $value) {
			// 			$count = 0;
			// 			if($diagnosis[$value] != null)
			// 				$count = $diagnosis[$value];
			// 			$diagnosis[$value] = ($count + 1);
			// 		}
			// 	}
			// }
			$mysql->closeDb();
			return $diagnosis;
		case INDEX_REGISTRATION:
		case INDEX_RECEPTION:
		case INDEX_DOCTOR:
		case INDEX_WAIT:
		case INDEX_CONSULTATION:
		default:break;
	}
}

/**
*	generalize a key
*/
function keyGeneralization($index, $oldKey){
	$newKeys = NULL;
	switch ($index) {
		case INDEX_DIAGNOSIS:
			$newKeys = explode(",",$oldKey);
			break;
		default:
			break;
	}
	return $newKeys;
}
?>